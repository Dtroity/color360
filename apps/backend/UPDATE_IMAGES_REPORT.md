# –û–¢–ß–Å–¢: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –¢–û–í–ê–†–û–í –ò API –õ–û–ì–ò–ù–ê

**–î–∞—Ç–∞:** 2024

---

## ‚úÖ –ó–ê–î–ê–ß–ê 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü:

#### –¢–∞–±–ª–∏—Ü–∞ `products`:
- **–ü–æ–ª—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
  - `images` (OneToMany) ‚Üí —Å–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π `product_images`
  - `metadata` (jsonb, nullable) ‚Üí –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `mainImage` –≤ JSON
  - **–ù–ï–¢** –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è `image_url` –≤ —Ç–∞–±–ª–∏—Ü–µ `products`

#### –¢–∞–±–ª–∏—Ü–∞ `product_images`:
- `id` (Primary Key)
- `url` (string) ‚Üí **–û–°–ù–û–í–ù–û–ï –ü–û–õ–ï –î–õ–Ø –ü–£–¢–ò –ö –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Æ**
- `alt` (varchar, nullable) ‚Üí –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç
- `sortOrder` (int, default: 0) ‚Üí –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- `productId` (Foreign Key) ‚Üí —Å–≤—è–∑—å —Å `products.id`
- `createdAt`, `updatedAt` ‚Üí –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω:

**–§–∞–π–ª:** `apps/backend/update-images.sql`

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ `product_images` –Ω–∞ `/placeholder-product.svg`
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
3. ‚úÖ –ü–æ–∫–∞–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ placeholder –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
5. ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞:

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ psql
psql -U postgres -d video_shop -f apps/backend/update-images.sql

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ pgAdmin
# –û—Ç–∫—Ä—ã—Ç—å pgAdmin ‚Üí –í—ã–±—Ä–∞—Ç—å –ë–î ‚Üí Tools ‚Üí Query Tool ‚Üí –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç ‚Üí Execute
```

---

## ‚úÖ –ó–ê–î–ê–ß–ê 2: API –ª–æ–≥–∏–Ω–∞

### –°–æ–∑–¥–∞–Ω Auth –º–æ–¥—É–ª—å:

**–§–∞–π–ª—ã:**
- ‚úÖ `apps/backend/src/modules/auth/auth.controller.ts` (—Å–æ–∑–¥–∞–Ω)
- ‚úÖ `apps/backend/src/modules/auth/auth.module.ts` (—Å–æ–∑–¥–∞–Ω)
- ‚úÖ `apps/backend/src/app.module.ts` (–æ–±–Ω–æ–≤–ª—ë–Ω - –¥–æ–±–∞–≤–ª–µ–Ω AuthModule)

### –ú–µ—Ç–æ–¥ login:

**Endpoint:** `POST /api/auth/login`

**Request Body:**
```json
{
  "email": "admin@hiwatch.ru",
  "password": "admin123"
}
```

**Response (Success - 200):**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "email": "admin@hiwatch.ru",
    "role": "admin"
  },
  "access_token": "mock-jwt-token-1234567890"
}
```

**Response (Error - 401):**
```json
{
  "statusCode": 401,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

–ú–µ—Ç–æ–¥ `login` –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ (email, timestamp)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ (user, token preview)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ (email, timestamp)

**–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:**
```
========================================
LOGIN ATTEMPT: { email: '...', password: '***', timestamp: '...' }
========================================
```

---

## üìã –°–¢–†–£–ö–¢–£–†–ê –¢–ê–ë–õ–ò–¶–´ PRODUCTS

### –ü–æ–ª—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏:

1. **`images`** (OneToMany)
   - –¢–∏–ø: –°–≤—è–∑—å —Å `ProductImage[]`
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–∞
   - –î–æ—Å—Ç—É–ø: –ß–µ—Ä–µ–∑ TypeORM relations

2. **`metadata`** (jsonb, nullable)
   - –¢–∏–ø: JSON –æ–±—ä–µ–∫—Ç
   - –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å: `{ mainImage: "/path/to/image.jpg" }`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

3. **–ù–ï–¢ –ø–æ–ª—è `image_url`**
   - –í —Ç–∞–±–ª–∏—Ü–µ `products` –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `product_images`

### –ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ã `product_images`:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | int (PK) | ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| `url` | string | **–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é** |
| `alt` | varchar (nullable) | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç |
| `sortOrder` | int | –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ |
| `productId` | int (FK) | ID —Ç–æ–≤–∞—Ä–∞ |
| `createdAt` | timestamp | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `updatedAt` | timestamp | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

---

## üîß –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –í–´–ü–û–õ–ù–ï–ù–ò–Æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql -U postgres -d video_shop

# –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
\i apps/backend/update-images.sql

# –ò–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ pgAdmin
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
```sql
-- –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
SELECT 
    p.id,
    p.name,
    p.sku,
    pi.url as image_url
FROM products p
LEFT JOIN product_images pi ON pi."productId" = p.id AND pi."sortOrder" = 0
WHERE p."isActive" = true
LIMIT 10;
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ª–æ–≥–∏–Ω–∞:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å backend
cd apps/backend
npm run start:dev

# –¢–µ—Å—Ç —á–µ—Ä–µ–∑ curl
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@hiwatch.ru","password":"admin123"}'

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "success": true,
#   "user": { "id": 1, "email": "admin@hiwatch.ru", "role": "admin" },
#   "access_token": "mock-jwt-token-..."
# }
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

–ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ backend –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:
```
========================================
LOGIN ATTEMPT: { email: 'admin@hiwatch.ru', password: '***', timestamp: '...' }
========================================
========================================
LOGIN SUCCESS: { user: {...}, token: 'mock-jwt-token-...', timestamp: '...' }
========================================
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´

1. ‚úÖ **SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω** - –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
2. ‚úÖ **Auth –º–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω** - —Å –º–µ—Ç–æ–¥–æ–º login
3. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
4. ‚úÖ **API –≥–æ—Ç–æ–≤** - endpoint `/api/auth/login` —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –∏–∑—É—á–µ–Ω–∞** - –ø–æ–ª—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥ –¥–ª—è –¥–µ–º–æ
   - –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–Ω–æ:
     - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
     - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bcrypt –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è
     - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π JWT —Ç–æ–∫–µ–Ω

2. **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
   - –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `product_images`
   - –ü–æ–ª–µ `url` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
   - Placeholder: `/placeholder-product.svg`

3. **–¢–æ–∫–µ–Ω:**
   - –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω - mock (–¥–ª—è –¥–µ–º–æ)
   - –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JWT —Å —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é

---

**–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ**

